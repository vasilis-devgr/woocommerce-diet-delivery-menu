jQuery(document).ready(function ($) {
  // on page load section opicity
  $(
    ".woopm-choose-program-section, .woopm-select-menu-section, .woopm-available-menu-section, .woopm-add-to-cart, .woopm-products, .woopm-allergens-section, .woopm-menu-submit, .woopm-add-to-cart-button"
  ).css({
    opacity: "0.5",
    cursor: "not-allowed",
  });

  $(
    ".woopm-choose-program, .woopm-select-menu, .kcal-category-select, .kcal-section-days, .woopm-add-to-cart-button, .woopm-add-to-cart-button"
  ).css({
    "pointer-events": "none",
  });

  // Search Zip Code matched start
  let debounceTimer;
  $(document).on("keyup", "#menu-zipcode", function (e) {
    let zipcode = $(this).val();

    clearTimeout(debounceTimer);

    if (zipcode.length === 5 || zipcode.length > 5) {
      debounceTimer = setTimeout(function () {
        $.ajax({
          url: woopm_ajax_object.ajax_url,
          type: "POST",
          data: {
            action: "check_shipping_zipcode",
            zipcode: zipcode,
            security: woopm_ajax_object.woopm_nonce,
          },
          success: function (response) {
            if (response.success) {
              $(".woopm-choose-program").prop("disabled", false);
              $(".zipcode-msg").html("ğŸ˜Š ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»ÎµÏ„Îµ");
              $(".woopm-choose-program-section").css({
                opacity: "1.0",
                cursor: "unset",
                "pointer-events": "unset",
              });
              $(".woopm-choose-program-section .form__radio-label").css({
                "pointer-events": "unset",
                cursor: "pointer",
              });
            } else {
              $(".zipcode-msg").html(
                "ğŸ˜ Î”Ï…ÏƒÏ„Ï…Ï‡ÏÏ‚, Î´ÎµÎ½ ÎµÎ¾Ï…Ï€Î·ÏÎµÏ„Î¿ÏÎ¼Îµ Î±ÎºÏŒÎ¼Î± Ï„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÎ±Ï‚"
              );
              $(".woopm-choose-program").prop("disabled", true);

              $(".woopm-choose-program-section").css({
                opacity: "0.5",
                "pointer-events": "not-allowed",
              });

              $(".woopm-choose-program-section").css({
                "pointer-events": "none",
              });
            }
          },
        });
      }, 500);
    }
  });
  // Search Zip Code matched end

  // Choose program start
  $('input[type="radio"].woopm-choose-program').change(function () {
    if ($('input[type="radio"].woopm-choose-program:checked').length) {
      let program = $(this).val();
      $.ajax({
        url: woopm_ajax_object.ajax_url,
        type: "POST",
        data: {
          action: "get_available_menu_by_program",
          program: program,
          security: woopm_ajax_object.woopm_nonce,
        },
        success: function (response) {
          $(".woopm-select-menu").prop("disabled", false);
          $(".woopm-select-menu-section").css({
            opacity: "1.0",
            cursor: "unset",
            "pointer-events": "unset",
          });
          $(".woopm-select-menu-section .form__radio-label").css({
            "pointer-events": "unset",
            cursor: "pointer",
          });
          $(".kcal-category-select").html(response.data.content);

          if ($('input[type="radio"].woopm-select-menu:checked').length) {
            setTimeout(function () {
              let menuType = $(
                'input[type="radio"].woopm-select-menu:checked'
              ).val();
              let programMenu = $(".kcal-category-select option:first").val();
              $.ajax({
                url: woopm_ajax_object.ajax_url,
                type: "POST",
                data: {
                  action: "get_product_by_program_type",
                  program: program,
                  program_menu: programMenu,
                  menu_type: menuType,
                  security: woopm_ajax_object.woopm_nonce,
                },
                success: function (response) {
                  $(".kcal-category-select").prop("disabled", false);
                  $(".kcal-select-days").prop("disabled", false);

                  if (menuType === "own") {
                    $(".kcal-section").hide();
                  } else {
                    $(".kcal-section").show();
                  }

                  $(
                    ".woopm-available-menu-section, .woopm-add-to-cart, .woopm-products, .woopm-allergens-section, .woopm-menu-submit, .kcal-section-days"
                  ).css({
                    opacity: "1.0",
                    cursor: "unset",
                    "pointer-events": "unset",
                  });

                  $(
                    ".woopm-add-to-cart-button, .woopm-menu-submit, .kcal-category-select, .kcal-select-days, .woopm-allergens-section .form__radio-label"
                  ).css({
                    opacity: "1.0",
                    "pointer-events": "unset",
                    cursor: "pointer",
                  });
                  $(".kcal-category-select").prop("disabled", false);
                  if (menuType == "own") {
                    $(".woopm-add-to-cart").hide();
                  } else {
                    $(".woopm-add-to-cart").show();
                  }
                  $(".woopm-products").html(response.data.content);
                  $(".woopm-product-prices").html(
                    `ÎšÏŒÏƒÏ„Î¿Ï‚: ` + response.data.kcal_total.total_price
                  );
                  // Initialize accordion after content is loaded
                  initializeAccordion();
                },
              });
            }, 500);
          }
        },
      });
    }
  });
  // Choose program end

  // Select menu start
  $('input[type="radio"].woopm-select-menu').change(function () {
    if ($('input[type="radio"].woopm-select-menu:checked').length) {
      let menuType = $(this).val();
      let program = $('input[type="radio"].woopm-choose-program:checked').val();
      let programMenu = $(".kcal-category-select").val();
      $.ajax({
        url: woopm_ajax_object.ajax_url,
        type: "POST",
        data: {
          action: "get_product_by_program_type",
          program: program,
          program_menu: programMenu,
          menu_type: menuType,
          security: woopm_ajax_object.woopm_nonce,
        },
        success: function (response) {
          $(".kcal-category-select").prop("disabled", false);
          $(".kcal-select-days").prop("disabled", false);

          if (menuType === "own") {
            $(".kcal-section").hide();
          } else {
            $(".kcal-section").show();
          }

          $(
            ".woopm-available-menu-section, .woopm-add-to-cart, .woopm-products, .woopm-allergens-section, .woopm-menu-submit, .kcal-section-days"
          ).css({
            opacity: "1.0",
            cursor: "unset",
            "pointer-events": "unset",
          });

          $(
            ".woopm-add-to-cart-button, .woopm-menu-submit, .kcal-category-select, .kcal-select-days, .woopm-allergens-section .form__radio-label"
          ).css({
            opacity: "1.0",
            "pointer-events": "unset",
            cursor: "pointer",
          });
          $(".kcal-category-select").prop("disabled", false);
          if (menuType == "own") {
            $(".woopm-add-to-cart").hide();
          } else {
            $(".woopm-add-to-cart").show();
          }
          $(".woopm-products").html(response.data.content);
          $(".woopm-product-prices").html(
            `ÎšÏŒÏƒÏ„Î¿Ï‚: ` + response.data.kcal_total.total_price
          );
          // Initialize accordion after content is loaded
          initializeAccordion();
        },
      });
    }
  });
  // Select menu end

  // available menus change start
  $(".kcal-category-select").on("change", function () {
    let program = $('input[type="radio"].woopm-choose-program:checked').val();
    let menuType = $('input[type="radio"].woopm-select-menu:checked').val();
    let programMenu = $(this).val();
    $.ajax({
      url: woopm_ajax_object.ajax_url,
      type: "POST",
      data: {
        action: "get_product_by_program_type",
        program: program,
        program_menu: programMenu,
        menu_type: menuType,
        security: woopm_ajax_object.woopm_nonce,
      },
      success: function (response) {
        $(".woopm-products").html(response.data.content);
        $(".woopm-product-prices").html(
          `ÎšÏŒÏƒÏ„Î¿Ï‚: ` + response.data.kcal_total.total_price
        );
        // Initialize accordion after content is loaded
        initializeAccordion();
      },
    });
  });
  // available menus change start

  // add to cart start
  $(document).on("click", ".woopm-add-to-cart-button", function (e) {
    e.preventDefault();
    let $button = $(this);

    let zipcode = $("#menu-zipcode").val();
    let currentProgram = $(
      'input[type="radio"].woopm-choose-program:checked'
    ).val();
    let currentProgramMenu = $(
      'input[type="radio"].woopm-select-menu:checked'
    ).val();
    let currentAvailableMenu = $(".kcal-category-select").val();
    let currentDay = $(".kcal-select-days").val();
    let currentAllergens = $(
      'input[type="radio"].woopm-select-allergens:checked'
    ).val();
    let currentAllergensOther = $(".woopm-select-allergens-other").val();

    /*if (!currentAllergens) { 
            alert("Î‘Î»Î»ÎµÏÎ³Î¹Î¿Î³ÏŒÎ½Î± & Î¹Î´Î¹Î±Î¯Ï„ÎµÏÎµÏ‚ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ Ï…Ï€Î¿Ï‡ÏÎµÎ¿ÏÎ¼Î±Î¹"); 
            return; 
        }

        if (currentAllergens.toLowerCase() === "other" && !currentAllergensOther) {
            alert("Î‘Î»Î»ÎµÏÎ³Î¹Î¿Î³ÏŒÎ½Î± & Î¹Î´Î¹Î±Î¯Ï„ÎµÏÎµÏ‚ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ Ï…Ï€Î¿Ï‡ÏÎµÎ¿ÏÎ¼Î±Î¹"); 
            return; 
        } */

    $button.prop("disabled", true);
    $button.css({
      "pointer-events": "none",
    });
    $button.html('<i class="fa fa-spinner fa-spin"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...');

    $.ajax({
      url: woopm_ajax_object.ajax_url,
      type: "POST",
      data: {
        action: "add_to_cart_product",
        zipcode: zipcode,
        current_program: currentProgram,
        current_program_menu: currentProgramMenu,
        current_available_menu: currentAvailableMenu,
        current_day: currentDay,
        current_allergens: currentAllergens,
        current_allergens_other: currentAllergensOther,
        security: woopm_ajax_object.woopm_nonce,
      },
      success: function (response) {
        if (response.success) {
          Swal.fire({
            title: "Cart",
            text: "Product added to cart successfully!",
            icon: "success",
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire({
            title: "Error",
            text: response.data,
            icon: "error",
            confirmButtonText: "Try Again",
          });
        }
      },
      error: function () {
        $button.prop("disabled", false);
        $button.css({
          "pointer-events": "unset",
        });
        $button.html("Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹");
      },
      complete: function () {
        $button.prop("disabled", false);
        $button.css({
          "pointer-events": "unset",
        });
        $button.html("Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹");
      },
    });
  });
  // add to cart end

  // add to cart single start
  $(document).on("click", ".product-add-to-cart", function (e) {
    e.preventDefault();
    let $button = $(this);
    $button.prop("disabled", true);
    $button.css({
      "pointer-events": "none",
    });
    $button.html('<i class="fa fa-spinner fa-spin"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...');

    let productId = $(this).attr("data-product_id");
    let zipcode = $("#menu-zipcode").val();
    let currentProgram = $(
      'input[type="radio"].woopm-choose-program:checked'
    ).val();
    let currentProgramMenu = $(
      'input[type="radio"].woopm-select-menu:checked'
    ).val();
    let currentAvailableMenu = $(".kcal-category-select").val();
    let currentDay = $(".kcal-select-days").val();
    let currentAllergens = $(
      'input[type="radio"].woopm-select-allergens:checked'
    ).val();
    let currentAllergensOther = $(".woopm-select-allergens-other").val();
    
    // Get schedule data from button attributes
    let weekId = $(this).attr("data-week") || "";
    let weekName = $(this).attr("data-week-name") || "";
    let dayId = $(this).attr("data-day") || "";
    let dayName = $(this).attr("data-day-name") || "";
    let mealId = $(this).attr("data-meal") || "";
    let mealName = $(this).attr("data-meal-name") || "";

    $.ajax({
      url: woopm_ajax_object.ajax_url,
      type: "POST",
      data: {
        action: "add_to_cart_single_product",
        product_id: productId,
        zipcode: zipcode,
        current_program: currentProgram,
        current_program_menu: currentProgramMenu,
        current_available_menu: currentAvailableMenu,
        current_day: currentDay,
        current_allergens: currentAllergens,
        current_allergens_other: currentAllergensOther,
        week_id: weekId,
        week_name: weekName,
        day_id: dayId,
        day_name: dayName,
        meal_id: mealId,
        meal_name: mealName,
        security: woopm_ajax_object.woopm_nonce,
      },
      success: function (response) {
        if (response.success) {
          let message = response.data.product_name + " added to cart!";
          if (response.data.schedule_info) {
            message += "\n" + response.data.schedule_info;
          }
          if (response.data.custom_price) {
            message += "\nPrice: " + response.data.custom_price;
          }
          
          // Update cart count in header
          if (response.data.cart_count) {
            $('.cart-contents-count').text(response.data.cart_count);
          }
          
          // Update mini cart fragments
          if (response.data.fragments) {
            $.each(response.data.fragments, function(key, value) {
              $(key).replaceWith(value);
            });
          }
          
          // Trigger WooCommerce events
          $(document.body).trigger('wc_fragment_refresh');
          $(document.body).trigger('added_to_cart', [response.data.fragments, response.data.cart_hash]);
          
          Swal.fire({
            title: "Success!",
            html: message.replace(/\n/g, '<br>'),
            icon: "success",
            timer: 2500,
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: "Error",
            text: response.data,
            icon: "error",
            confirmButtonText: "Try Again",
          });
        }
      },
      error: function () {
        $button.prop("disabled", false);
        $button.css({
          "pointer-events": "unset",
        });
        $button.html("Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹");
      },
      complete: function () {
        $button.prop("disabled", false);
        $button.css({
          "pointer-events": "unset",
        });
        $button.html("Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹");
      },
    });
  });
  // add to cart single end

  // Allergens start
  $('input[type="radio"].woopm-select-allergens').change(function () {
    if ($('input[type="radio"].woopm-select-allergens:checked').length) {
      let allergens = $(this).val();
      if (allergens == "other") {
        $(".woopm-select-allergens-other-section").show();
      } else {
        $(".woopm-select-allergens-other-section").hide();
      }
    }
  });
  // Allergens end
});
